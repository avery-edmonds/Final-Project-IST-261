<html>
    <head>
         <title>MyMed</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </head>
    <body style="background-color: #6DA7FD;">
        <div class="container" style="height:100vh; display: flex; justify-content: center; align-items: center;">
            <div class="row justify-content-center">
                <div style="max-width: 500px; width: 100%;">
                    <div class="card shadow-sm" style="width: 500px">
                        <div class="card-body shadow">
                            <h1 class="card-title text-center mb-2">Register</h1>
                            <p class="text-center" style="font-weight: bold; margin-bottom: 0;">Welcome.</p>
                            <p class="text-center">Your Doctors can be just a click away!</p>
                            
                            <div class="mb-3 row">
                              <div class = "col-6">
                                <h6 class="form-label">First Name</h6>
                                <input id="firstName" type="text" placeholder="First Name" class="form-control" required>
                              </div>
                              <div class = "col-6">
                              	<h6 class="form-label">Last Name</h6>
                              	<input id="lastName" type="text" placeholder="Last Name" class="form-control" required>
                            </div>
                          </div>
                              <div class="mb-3 row">
                                <div class = "col-6">
                                  <h6 class= "form-label">Birth Date</h6>
                                  <input id="dob" type="date" class="form-control">
                              </div>
                                <div class="col-6">
                                  <h6 class = "form-label">Insurance Company</h6>
                                  <input id="insurance" type="text" placeholder="Insurance Company" class="form-control">
                               </div>
                          </div>
                          <div class="mb-3 row">
                            <div class="col-6">
                              	<h6 class="form-label">Email</h6>
                              	<input id="email" type="email" placeholder="Email" class="form-control" required>
                            </div>
                            <div class="col-6">
                            	<h6 class="form-label">Username</h6>
                              	<input id="username" type="text" placeholder="Username" class="form-control" required>
                            </div>
                          </div>
                            <div class="mb-3">
                                <h6 class="form-label">Password</h6>
                                <input id="password" type="password" placeholder="Password" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <p>Already a MyMed user? 
                                    <a href="login.html" style="color: inherit; font-weight: bold; text-decoration: none;">
                                        Login Here!</a></p>
                            </div>
                            <button class="btn btn-primary w-100" onclick="register()" type="button">Register</button>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        const API_URL = "http://localhost:8080"
        
        async function register() {
            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;
            const birthDate = document.getElementById("dob").value;
            const insurance = document.getElementById("insurance").value;
            const email = document.getElementById("email").value;
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

    
    // Check email
    const emailCheck = await fetch(`${API_URL}/users/exists/email?email=${email}`);
    const emailTaken = await emailCheck.json();

    if (emailTaken) {
        alert("This email is already in use.");
        return;
    }

    // Check username
    const userCheck = await fetch(`${API_URL}/api/exists/username?username=${username}`);
    const usernameTaken = await userCheck.json();

    if (usernameTaken) {
        alert("This username is already taken.");
        return;
    }

    const userData = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        birthDate: dob,
        insurance: insurance
    };

    try {
       
        const createUserResponse = await fetch(`${API_URL}/users`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(userData)
        });

        if (!createUserResponse.ok) {
            alert("Failed to create user. Error: " + createUserResponse.status);
            return;
        }

        const newUser = await createUserResponse.json();
        const newUserId = newUser.id;

        alert("User created! ID: " + newUserId);

        const loginData = {
            username: username,
            password: password
        };

        const loginResponse = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(loginData)
        });

        if (!loginResponse.ok) {
            alert("User account created, but login creation failed!");
            return;
        }

        alert("Login created! You can now log in.");

        localStorage.setItem("userId", newUserId);
        window.location.href = "index.html";

    } catch (err) {
        console.error("Register error:", err);
        alert("An error occurred during registration.");
    }
            
        }
    </script>
</html>